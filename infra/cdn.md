# 内容分发网络 (CDN)

## 概览

内容分发网络由经过优化的服务器网络组成，用于快速向用户分发内容。虽然 CDN 在提供缓存内容方面最有名气，但 CDN 还可以改善无法缓存内容的分发。一般来说，您的 CDN 分发的网站越多越好。

概括来讲，CDN 的性能优势源于若干原则：CDN 服务器比源服务器更靠近用户，因此具有较短的往返时间 (RTT) 延迟时间；网络优化使 CDN 能够比从源服务器“直接”加载内容更快地分发内容；最后，CDN 缓存不需要将请求传输到源服务器。

## 资源分发

虽然这看起来不太直观，但使用 CDN 来分发资源（即使是无法缓存的资源）通常比让用户从您的服务器“直接”加载资源更快。

使用 CDN 从来源分发资源时，客户端和附近的 CDN 服务器之间会建立新的连接。历程的其余部分（即 CDN 服务器与源站之间的数据传输）通过 CDN 网络进行，该网络通常包括与源站的现有持久连接。这样做有两方面的好处：在尽可能靠近用户的位置终止新连接可以避免不必要的连接设置成本（建立新连接成本高昂，并且需要多次往返）；使用预热连接可以立即以尽可能高的吞吐量传输数据。

某些 CDN 在这一点上进一步改进，通过分布在互联网上的多个 CDN 服务器将流量路由到源站。CDN 服务器之间的连接是通过高度优化的可靠路由进行的，而不是通过
[边界网关协议 (BGP)](https://en.wikipedia.org/wiki/Border_Gateway_Protocol)确定的路由。虽然 BGP 是互联网实际上的路由协议，但其路由决策并不总是以性能为导向。因此，BGP 确定的路由的性能可能不如 CDN 服务器之间微调的路由。

## 缓存

通过缓存 CDN 服务器上的资源，您无需将请求直接传送至源站以供传送。因此，资源的交付速度更快；这也减轻了源服务器的负载。

### 将资源添加到缓存

填充 CDN 缓存的最常用方法是让 CDN 根据需要“拉取”资源，这称为“源拉取”。首次从缓存中请求特定资源时，CDN 将从源服务器请求该资源并缓存响应。通过这种方式，当有其他未缓存的资源被请求时，缓存的内容会随着时间的推移而积累。

### 从缓存中移除资源

CDN 使用缓存逐出功能定期从缓存中移除没用的资源。此外，网站所有者可以使用完全清除功能来明确移除资源。

- 缓存逐出

  缓存的存储空间容量有限。当缓存即将用尽容量时，它会移除最近未访问过的资源或占用大量空间的资源，从而为新资源腾出空间。此过程称为缓存逐出。某个资源从一个缓存中逐出并不一定意味着它已从 CDN 网络的所有缓存中逐出。

- 完全清除

  清除（也称为“缓存失效”）是一种将资源从 CDN 的缓存中移除的机制，无需等待该资源过期或被逐出。它通常通过 API 执行。在需要撤消内容的情况下（例如，更正拼写错误、定价错误或错误的新闻报道），完全清除功能至关重要。此外，它还可以在网站的缓存策略中起到至关重要的作用。

  如果 CDN 支持近乎即时完全清除，则可将完全清除用作一种管理动态内容缓存的机制：使用长 TTL 缓存动态内容，然后在资源更新时完全清除资源。通过这种方式，即使事先不知道资源何时将发生变化，也可以最大限度地延长动态资源的缓存时长。此技术有时称为“暂停付款”缓存。

  在大规模使用时，完全清除操作通常与称为“缓存标记”或“代理缓存键”的概念结合使用。利用这种机制，网站所有者可以将一个或多个其他标识符（有时称为“代码”）与缓存的资源相关联。这些代码随后可用于执行高度细化的完全清除。例如，您可以向包含网站页脚的所有资源（例如 /about、/blog）添加“footer”标记。页脚更新后，指示您的 CDN 完全清除与“footer”标记关联的所有资源。

### 可缓存的资源

是否应缓存资源以及如何缓存资源，取决于该资源是公共资源还是私有资源；是静态资源还是动态资源。

#### 私有资源和公开资源

- 私有资源

  私有资源包含面向单个用户的数据，因此不应由 CDN 进行缓存。专用资源由 `Cache-Control: private` 标头指示。

- 公共资源

  公共资源不包含用户特定信息，因此可由 CDN 缓存。如果某项资源没有 `Cache-Control: no-store` 或 `Cache-Control: private` 标头，则 CDN 可能会将其视为可缓存的资源。公开资源可缓存的时间长度取决于该资源的更改频率。

#### 动态和静态内容

- 动态内容

  动态内容是指频繁变动的内容。此类内容的示例包括 API 响应和商店首页。不过，此内容频繁更改，并不一定会阻止系统对其进行缓存。在流量大的时段，将这些响应缓存很短的时间（例如 5 秒）可以显著减少源服务器的负载，同时对数据新鲜度的影响微乎其微。

- 静态内容

  静态内容不会经常更改（如果有）。此类内容通常包括图片、视频和版本化库。由于静态内容不会发生变化，因此应采用较长的生存时间 (TTL) 进行缓存，例如 6 个月或 1 年。

## 选择 CDN

在选择 CDN 时，性能通常是首要考虑因素。但是，在选择 CDN 时，CDN 提供的其他功能（例如安全和分析功能）以及 CDN 的价格、支持和初始配置都是重要的考虑因素。

### 性能

概括来讲，您可以在最大限度地缩短延迟时间和最大限度提高缓存命中率之间的权衡来考虑 CDN 的性能策略。具有许多入网点 (PoP) 的 CDN 可以提供较低的延迟，但由于流量在更多缓存中拆分，因此缓存命中率可能会较低。相反，PoP 较少的 CDN 可能在地理位置上距离用户较远，但可以实现更高的缓存命中率。

由于这种权衡，一些 CDN 使用分层方法进行缓存：靠近用户的 PoP（也称为“边缘缓存”）以具有较高缓存命中率的中央 PoP 作为补充。当边缘缓存找不到某个资源时，会向中央 PoP 寻找该资源。这种方法的代价是延迟时间略长，但增加了从 CDN 缓存提供资源的可能性，但并不一定是边缘缓存。

最大限度地缩短延迟时间与最大限度提高缓存命中率之间的权衡是面面俱到的。没有哪一种方法是普遍适用的，不过，根据您网站的性质及其用户群，您可能会发现其中一种方法的效果明显优于另一种。

另外值得注意的是，CDN 性能可能会因地理位置、一天中的时段甚至时事而异。虽然自行研究 CDN 的性能始终是个好主意，但很难预测 CDN 能为您带来的确切性能。

### 对 Largest Contentful Paint (LCP) 的影响

如本文前面所述，CDN 的主要目的是将资源分配到地理位置上更靠近用户的服务器，从而减少延迟时间。因此，CDN 的主要优势在于可以提高加载性能。特别是，在网站的服务器端架构中引入 CDN 后，资源的[第一字节时间 (TTFB)](https://web.dev/articles/ttfb?hl=zh-cn) 可以显著缩短。

虽然 TTFB 不是以[用户为中心的性能指标](https://web.dev/articles/user-centric-performance-metrics?hl=zh-cn)，但是诊断 L[argest Contentful Paint (LCP)](https://web.dev/articles/lcp?hl=zh-cn)（以用户为中心的指标）存在的问题的重要指标。

CDN 在改进 LCP 方面尤其有效，因为它们可以改进文档传送（通过减少连接设置和缓存文档中的 TTFB），并改善渲染 LCP 元素所需的任何静态资源的传送。

### 其他功能

CDN 通常除了提供核心 CDN 产品之外，还提供多种其他功能。常用的功能包括：负载均衡、图像优化、视频串流、边缘计算和安全产品。
